/*
*
* Author Lennard Kuenen
* 
* Site https://discussion.lennardkuenen.dev
*
* Documentation https://github.com/LennardKu/discussion
*/
"use strict";const discussion={cdn:"https://cdn.lennardkuenen.dev",api:"https://api.lennardkuenen.dev",discussionPage:"https://discussion.lennardkuenen.dev",loginPage:"https://login.lennardkuenen.dev",session:null,init:async function(){null===this.session&&await this.userSession();let s=document.createElement("link");s.href=`${this.cdn}/styles/css/discussion.css`,s.type="text/css",s.rel="stylesheet",s.media="screen,print",document.getElementsByTagName("head")[0].appendChild(s),this.reload()},reload:async function(){let s=document.querySelectorAll("[data-discussion-field]");for(let e=0;e<s.length;e++)await discussion.checkField(s[e].getAttribute("data-discussion-field"))?(s[e].hasAttribute("data-discussion-comment-loaded")||(s[e].setAttribute("data-discussion-offset","0"),s[e].setAttribute("data-discussion-limit","25"),s[e].innerHTML="",s[e].innerHTML=`<div class="discussion-block" data-discussion-content> <div class="discussion-block-header" data-discussion-header><div class="title"><h2>Comments</h2></div><div class="group-radio"></div></div><div class="writing" data-discussion-reply></div><div data-discussion-comments></div><div class="discussion-load" data-discussion-load> <span data-discussion-loadmore>Load more</span> <span data-discussion-loading><i class="ri-refresh-line"></i>Loading</span> <span data-discussion-provided> Provided by &nbsp;<a target="_blank" href="${discussion.discussionPage}"> Lennardkuenen.dev</a></span></div></div>`,discussion.loadPosts(s[e]),s[e].querySelectorAll("[data-discussion-content] [data-discussion-loadmore]")[0].addEventListener("click",function(){discussion.loadPosts(s[e])})),discussion.config(s[e])):s[e].innerHTML="Field not allowed with this host"},config:async function(s){if(!1===this.session){await this.loginField(s);return}await this.commentField(s)},loginField:function(s){let e=discussion.createUuid(),i=`<div contenteditable="false" class="textarea" style="height:80px" autofocus spellcheck="false"><p>You are currently not logged in. please login to place a comment.</div><div class="discussion-footer"><div class="text-format"></div><div class="group-button"><button class="btn primary" data-discussion-login="${e}">Login</button></div></div>`;s.querySelectorAll("[data-discussion-content] [data-discussion-reply]")[0].innerHTML=i;let t=document.querySelectorAll(`[data-discussion-login="${e}"]`)[0];t.addEventListener("click",function(){discussion.userAuth(t)})},commentField:function(s){let e=`
    <textarea contenteditable="true" class="textarea" data-discussion-textarea="" autofocus spellcheck="false"></textarea><div class="discussion-footer"><div class="text-format">       <div class="user-banner"><div class="user"><div class="avatar"><img src="${discussion.api}/profilePicture/${discussion.session.userInformation.uuid}" data-discussion-load=""></div><h5 style="margin:0;">${discussion.session.userInformation.displayName}</h5></div></div></div><div class="group-button"><button class="btn primary" data-discussion-send>Send</button></div></div><p data-discussion-error></p>`;s.querySelectorAll("[data-discussion-content] [data-discussion-reply]")[0].innerHTML=e,s.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].addEventListener("click",function(){discussion.commitComment(s)})},commentErrorDisplay:function(s,e){e.querySelectorAll("[data-discussion-content] [data-discussion-reply] [data-discussion-error]")[0].innerHTML=s},commitComment:function(s){let e=s.getAttribute("data-discussion-field"),i=s.querySelectorAll("[data-discussion-content] [data-discussion-reply] [data-discussion-textarea]")[0].value,t=discussion.session.userInformation.uuid||"";if(s.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].setAttribute("disabled",!0),s.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].innerHTML='<i class="ri-more-line"></i> Sending...',discussion.commentErrorDisplay("",s),0==t.replace(" ","").length||0==i.replace(" ","").length){setTimeout(()=>{s.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].removeAttribute("disabled"),s.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].innerHTML="Send",discussion.commentErrorDisplay("Please enter a comment before submitting.",s)},100);return}let n=`${this.api}/discussion/v2/submit/${e}/?postType=comment`,o=new FormData;o.append("session",this.getCookie("discussion")),o.append("comment",i),this.sendComment(n,o,!1,s)},sendComment:function(s,e,i=!1,t){fetch(s,{method:"POST",body:e}).then(s=>s.json()).then(e=>(console.log(t),void 0!==e.fieldId&&setTimeout(()=>{t.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].removeAttribute("disabled"),t.querySelectorAll("[data-discussion-content] [data-discussion-textarea]")[0].value="",t.querySelectorAll("[data-discussion-content] [data-discussion-send]")[0].innerHTML="Send",void 0!==t.querySelectorAll('[data-discussion-content] [data-discussion-first="comment"]')[0]&&t.querySelectorAll('[data-discussion-first="comment"]')[0].remove()},250),void 0!==e.error)?(discussion.commentErrorDisplay("Something went wrong while submitting.",t),!0):e.success?(discussion.getSinglePost(t,e.id),!0):(!1===i&&discussion.log("error.send",`URL: ${s} -- DATA: ${e}`),e))},getSinglePost:function(s,e){fetch(`${discussion.api}/discussion/v2/singlePost/${s.getAttribute("data-discussion-field")}/?commentId=${e}`).then(s=>s.json()).then(e=>{let i=new Date(e.created_at),t=discussion.formatDate(i,"ddd d MMM yyyy"),n=!1,o="";void 0!==discussion.session.userInformation&&(o=discussion.session.userInformation.uuid||""),(s.hasAttribute("data-discussion-mod")||e.creator==o)&&(n=!0),s.querySelectorAll("[data-discussion-content] [data-discussion-comments]")[0].innerHTML=`<div class="comment"><div class="user-banner" data-discussion-comment="${e.uid}"><div class="user"><div class="avatar"><img src="${discussion.api}/profilePicture/${e.creator}" data-discussion-load=""></div><h5>${e.displayName}</h5></div><button class="btn dropdown ${n?"discussion-active":"discussion-hidden"}" data-discussion-edit=""><i class="ri-more-line"></i></button></div><div class="content comment-field-content"><p>${e.comment}</p></div><div class="discussion-footer"><div class="divider"></div><div class="divider"></div><span class="is-mute">${t}</span></div></div></div>`+s.querySelectorAll("[data-discussion-content] [data-discussion-comments]")[0].innerHTML,s.setAttribute("data-discussion-offset",Number(s.getAttribute("data-discussion-offset"))+Number(1))})},post:async function(s="",e={}){let i=await fetch(s,{method:"POST",body:e});return i.json()},userInformation:async function(s){return(await fetch(`${this.api}/user/session/?id=${s}`,{method:"GET",cache:"no-cache"})).json()},userSession:async function(){!1==this.getCookie("discussion")&&this.setCookie("discussion",`${discussion.createUuid()}-${discussion.createUuid()}`,356),await this.userInformation(this.getCookie("discussion")).then(s=>{if(s.success){this.session=s;return}this.session=!1}).catch(s=>{discussion.log("error.userSession",s)})},userAuth:function(s){s.innerHTML='<i class="ri-refresh-line"></i>&nbsp;Loading...';let e=window.open(`${this.loginPage}/auth/${this.getCookie("discussion")}/?key=${discussion.createUuid()}/?iframe=true&crossLogin=true`,"Login","location=1,status=1,scrollbars=1,resizable=0,width=400,height=600,menubar=no,toolbar=no");window.addEventListener("beforeunload",function(s){e.close()}),function s(i){setTimeout(async function(){i?(window.removeEventListener("beforeunload",await discussion.userSession(),!0),discussion.reload()):s(e.closed)},1500)}(e.closed)},checkField:async function(s){let e=await discussion.post(`${discussion.api}/discussion/v2/fieldAccess/${s}`);return!e.error||(console.log(`Field ${s} is not supported. ${e.solution}`),!1)},modChecker:async function(s){return!!(await discussion.post(`${discussion.api}/discussion/v2/modChecker/${s}`,{userUUid:discussion.session.userUuid||""})).success},loadPosts:async function(s){await discussion.modChecker(s.getAttribute("data-discussion-field"))&&s.setAttribute("data-discussion-mod",!0),s.setAttribute("data-discussion-comment-loaded",!0),s.querySelectorAll("[data-discussion-loading]")[0].classList.add("hide");let e=s.getAttribute("data-discussion-field"),i=s.getAttribute("data-discussion-limit"),t=s.getAttribute("data-discussion-offset");fetch(`${discussion.api}/discussion/v2/posts/${e}/?limit=${i}&offset=${t}`).then(s=>s.json()).then(e=>{if(console.log(e.length),e.length<i?(s.setAttribute("data-discussion-loaded",!0),s.querySelectorAll("[data-discussion-content] [data-discussion-loadmore]")[0].classList.add("discussion-hidden")):s.querySelectorAll("[data-discussion-content] [data-discussion-loadmore]")[0].classList.contains("discussion-hidden")&&s.querySelectorAll("[data-discussion-content] [data-discussion-loadmore]")[0].classList.remove("discussion-hidden"),0==e.length&&0==t){s.querySelectorAll("[data-discussion-content] [data-discussion-comments]")[0].innerHTML='<center data-discussion-first="comment"><p><b>No comments yet. Be the first to comment</b></p></center>';return}for(let n of e){let o=new Date(n.created_at),d=discussion.formatDate(o,"ddd d MMM yyyy"),a=!1,c="";void 0!==discussion.session.userInformation&&(c=discussion.session.userInformation.uuid||""),(s.hasAttribute("data-discussion-mod")||n.creator==c)&&(a=!0),s.querySelectorAll("[data-discussion-content] [data-discussion-comments]")[0].innerHTML=s.querySelectorAll("[data-discussion-content] [data-discussion-comments]")[0].innerHTML+`<div class="comment"><div class="user-banner" data-discussion-comment="${n.uid}"><div class="user"><div class="avatar"><img src="${discussion.api}/profilePicture/${n.creator}" data-discussion-load=""></div><h5>${n.displayName}</h5></div><button class="btn dropdown ${a?"discussion-active":"discussion-hidden"}" data-discussion-edit=""><i class="ri-more-line"></i></button></div><div class="content comment-field-content"><p>${n.comment}</p></div><div class="discussion-footer"><div class="divider"></div><div class="divider"></div><span class="is-mute">${d}</span></div></div></div>`}s.setAttribute("data-discussion-offset",Number(t)+Number(i))})},diffHours:function(s,e){let i=(s.getTime()-e.getTime())/1e3;return Math.abs(Math.round(i/=3600))},formatDate:function(s,e,i){let t=["\0","January","February","March","April","May","June","July","August","September","October","November","December"],n=["\x01","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=["\x02","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=["\x03","Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function a(s,e){let i=s+"";for(e=e||2;i.length<e;)i="0"+i;return i}let c=i?s.getUTCFullYear():s.getFullYear();e=(e=(e=e.replace(/(^|[^\\])yyyy+/g,"$1"+c)).replace(/(^|[^\\])yy/g,"$1"+c.toString().substr(2,2))).replace(/(^|[^\\])y/g,"$1"+c);let r=(i?s.getUTCMonth():s.getMonth())+1;e=(e=(e=(e=e.replace(/(^|[^\\])MMMM+/g,"$1"+t[0])).replace(/(^|[^\\])MMM/g,"$1"+n[0])).replace(/(^|[^\\])MM/g,"$1"+a(r))).replace(/(^|[^\\])M/g,"$1"+r);let u=i?s.getUTCDate():s.getDate();e=(e=(e=(e=e.replace(/(^|[^\\])dddd+/g,"$1"+o[0])).replace(/(^|[^\\])ddd/g,"$1"+d[0])).replace(/(^|[^\\])dd/g,"$1"+a(u))).replace(/(^|[^\\])d/g,"$1"+u);let l=i?s.getUTCHours():s.getHours();e=(e=e.replace(/(^|[^\\])HH+/g,"$1"+a(l))).replace(/(^|[^\\])H/g,"$1"+l);let m=l>12?l-12:0==l?12:l;e=(e=e.replace(/(^|[^\\])hh+/g,"$1"+a(m))).replace(/(^|[^\\])h/g,"$1"+m);let g=i?s.getUTCMinutes():s.getMinutes();e=(e=e.replace(/(^|[^\\])mm+/g,"$1"+a(g))).replace(/(^|[^\\])m/g,"$1"+g);let p=i?s.getUTCSeconds():s.getSeconds();e=(e=e.replace(/(^|[^\\])ss+/g,"$1"+a(p))).replace(/(^|[^\\])s/g,"$1"+p);let f=i?s.getUTCMilliseconds():s.getMilliseconds();e=e.replace(/(^|[^\\])fff+/g,"$1"+a(f,3)),f=Math.round(f/10),e=e.replace(/(^|[^\\])ff/g,"$1"+a(f)),f=Math.round(f/10);let h=l<12?"AM":"PM";e=(e=(e=e.replace(/(^|[^\\])f/g,"$1"+f)).replace(/(^|[^\\])TT+/g,"$1"+h)).replace(/(^|[^\\])T/g,"$1"+h.charAt(0));let v=h.toLowerCase();e=(e=e.replace(/(^|[^\\])tt+/g,"$1"+v)).replace(/(^|[^\\])t/g,"$1"+v.charAt(0));let $=-s.getTimezoneOffset(),y=i||!$?"Z":$>0?"+":"-";if(!i){let b=Math.floor(($=Math.abs($))/60),_=$%60;y+=a(b)+":"+a(_)}e=e.replace(/(^|[^\\])K/g,"$1"+y);let A=(i?s.getUTCDay():s.getDay())+1;return e=(e=(e=(e=(e=e.replace(RegExp(o[0],"g"),o[A])).replace(RegExp(d[0],"g"),d[A])).replace(RegExp(t[0],"g"),t[r])).replace(RegExp(n[0],"g"),n[r])).replace(/\\(.)/g,"$1")},createUuid:function(){let s=new Uint8Array(16);crypto.getRandomValues(s);let e="";for(let i=0;i<s.length;i++)e+=s[i].toString(16).padStart(2,"0");return`${e.substr(0,8)}-${e.substr(8,4)}-${e.substr(12,4)}-${e.substr(16,4)}-${e.substr(20,12)}`},setCookie:function(s,e,i){let t="";if(i){let n=new Date;n.setTime(n.getTime()+864e5*i),t="; expires="+n.toUTCString()}document.cookie=`${s} = ${e||""} ${t}; path=/`},getCookie:function(s){let e=s+"=",i=document.cookie.split(";");for(let t=0;t<i.length;t++){let n=i[t];for(;" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(e))return n.substring(e.length,n.length)}return!1},deleteCookie:function(s){document.cookie=`${s}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;`},log:function(s,e){let i=`${this.api}/log/post/`,t={type:s,data:e,session:discussion.getCookie("discussion")};this.post(i,t,!0)}};discussion.init();

