/*
*
* Author Lennard K
* 
* Site https://discussion.kuenenwebsites.com
*
* Documentation https://github.com/LennardKu/discussion
*/
"use strict";const siteKey=document.currentScript.getAttribute("siteKey"),discussion={userSession:null,siteUuid:null,enableStyleScript:!0,sessionValue:null,version:"v1",api:"https://kuenenwebsites.com/api",cdn:"https://kuenenwebsites.com/cdn",loginPage:"https://kuenenwebsites.com/login",siteAddress:"https://kuenenwebsites.com/discussion",config:async function(e){if(this.loading("messageContainers",!0),this.siteUuid=e,null==this.siteUuid||0==this.siteUuid.length){this.log("noSiteUuid.error",`No site key set ${window.location.href}`),this.error(`No site key set: ${this.siteAddress}/about/activate/`);return}if(null==this.getCookie("discussionSession")&&null==this.userSession&&this.setCookie("discussionSession",this.createUuid(),356),this.userSession=this.getCookie("discussionSession"),!0==this.enableStyleScript){let s=document.createElement("link");s.href=`${this.cdn}/style/css/discussion.css`,s.type="text/css",s.rel="stylesheet",s.media="screen,print",document.getElementsByTagName("head")[0].appendChild(s)}await this.reload()},init:function(){for(let e=0;e<document.querySelectorAll("[data-discussion-for]").length;e++)document.querySelectorAll("[data-discussion-for]")[e].addEventListener("submit",function(){discussion.send(this.getAttribute("data-discussion-for"))})},reload:async function(){this.checkSession(),function e(s){setTimeout(async function(){null==discussion.sessionValue?e():(await discussion.createAnswerField(),await discussion.init())},1e3)}()},createAnswerField:async function(){for(let e=0;e<document.querySelectorAll("[data-discussion-answer-field]").length;e++)if(!1!==this.sessionValue&&null!==this.sessionValue&&void 0!==this.sessionValue){let s=document.createElement("div"),t=document.createElement("form"),i=document.createElement("textarea"),n=document.createElement("button"),o=document.createElement("input");s.classList.add("discussion-answer-wrapper"),t.classList.add("discussion-answer-form"),n.classList.add("discussion-answer-submit"),n.setAttribute("type","submit"),i.setAttribute("name","message"),o.setAttribute("uuid",this.createUuid()),o.setAttribute("hidden",!0),n.innerHTML="Versturen",t.appendChild(o),t.appendChild(i),t.appendChild(n),s.appendChild(t),document.querySelectorAll("[data-discussion-answer-field]")[e].innerHTML="",document.querySelectorAll("[data-discussion-answer-field]")[e].appendChild(s),document.querySelectorAll("[data-discussion-answer-field]")[e].classList.remove("loading")}else{let r=document.createElement("div"),a=document.createElement("span"),d=document.createElement("button");a.classList.add("discussion-not-registered"),d.classList.add("discussion-not-registered-btn");let u=this.createUuid();d.setAttribute("data-discussion-login",u),a.innerHTML="You are not logged in.",d.innerHTML="Login",r.appendChild(a),r.appendChild(d),d.addEventListener("click",function(){discussion.login(u)}),document.querySelectorAll("[data-discussion-answer-field]")[e].innerHTML="",document.querySelectorAll("[data-discussion-answer-field]")[e].appendChild(r)}},loading:function(e,s,t){if("btnLoadingLogin"==s&&!0==e){t.setAttribute("data-old-text","test"),t.innerHTML="Laden...";return}if("btnLoadingLogin"==s&&!1==e){t.innerHTML=t.getAttribute("data-old-text");return}if("messageContainers"==s&&!0==e){for(let i=0;i<document.querySelectorAll("[data-discussion-answer-field]").length;i++)document.querySelectorAll("[data-discussion-answer-field]")[i].classList.add("loading");return}},login:function(e){this.loading(!0,"btnLoadingLogin",document.querySelectorAll(`[data-discussion-login="${e}"]`)[0]);let s=window.open(`${this.loginPage}/auth/${this.userSession}/`,"Login","location=1,status=1,scrollbars=1,resizable=no,width=400,height=600,menubar=no,toolbar=no");!function e(t){setTimeout(function(){t?discussion.reload():e(s.closed)},1500)}(s.closed)},createUuid:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))},setCookie:function(e,s,t){let i="";if(t){let n=new Date;n.setTime(n.getTime()+864e5*t),i="; expires="+n.toUTCString()}document.cookie=`${e} = ${s||""} ${i}; path=/`},getCookie:function(e){let s=e+"=",t=document.cookie.split(";");for(let i=0;i<t.length;i++){let n=t[i];for(;" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(s))return n.substring(s.length,n.length)}return null},deleteCookie:function(e){document.cookie=`${e}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;`},send:function(e){let s=new XMLHttpRequest,t=`${this.api}/discussion/${this.version}/post/`,i=`session=${this.userSession}&uuid=${e}`;s.open("POST",t,!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){4==s.readyState&&s.status},s.send(i)},checkSession:async function(){let e=new XMLHttpRequest,s=`${this.api}/discussion/${this.version}/session/`,t=`session=${this.userSession}`;e.open("GET",s,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){let s=JSON.parse(e.responseText);if(void 0!==s.error){discussion.sessionValue=!1;return}discussion.sessionValue=s}},e.send(t)},delete:function(e,s){let t=new XMLHttpRequest,i=`${this.api}/discussion/${this.version}/delete/`,n=`session=${this.userSession}&type=${e}&uuid=${s}`;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){if(void 0!==t.responseText.error)return discussion.log("delete.error",t.responseText.error),!1;if(void 0!==t.responseText.success)return discussion.log("delete.success",t.responseText.success),!1}},t.send(n)},getPosts:function(e,s,t,i){t=t||20,i=i||0;let n=new XMLHttpRequest,o=`${this.api}/discussion/${this.version}/get/`,r=`session=${this.userSession}&uuid=${s}&type=${e}&limit=${t}&offset=${i}`;n.open("GET",o,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status&&void 0!==n.responseText.error)return discussion.log("getPosts.error",n.responseText.error),!1},n.send(r)},getSingle:function(e,s,t){let i=new XMLHttpRequest,n=`${this.api}/discussion/${this.version}/getSingle/`,o=`session=${this.userSession}&uuid=${s}&type=${e}`;i.open("GET",n,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){if(void 0!==i.responseText.error)return discussion.log("getSingle.error",i.responseText.error),!1;if("return"==t)return i.responseText}},i.send(o)},error:function(e){throw Error(e)},log:function(e,s){let t=new XMLHttpRequest,i=`${this.api}/discussion/log/`,n=`message=${s}&type=${e}&session=${this.userSession}`;t.open("POST",i,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){4==t.readyState&&200==t.status&&void 0!==t.responseText.error&&discussion.error(t.responseText.error)},t.send(n)}};window.addEventListener("load",function(){discussion.config(siteKey)});
